from src.clients import GigaClient
from src.repositories import MeasureRepository, RegionRepository

region_prompt = '''
    Сейчас пользователь пришлёт тебе сообщение, в котором должен содержаться регион проживания пользователя.
    Возможно, пользователь написал название своего региона с ошибками.
    Отправь правильное название региона, если сможешь его определить.
    Если не сможешь, то отправь сообщение "unknown region"

'''

measure_prompt = '''
    # ЗАДАЧА: Поиск мер поддержки по текстовому запросу пользователя

    ## ИНСТРУКЦИЯ:
    Ты помогаешь найти подходящие меры поддержки из базы данных. Пользователь описывает свою потребность в свободной форме.

    ## ДАННЫЕ:
    Доступные меры поддержки (ID - Название):
    {}

    ## ПРАВИЛА ПОИСКА:
    1. Анализируй СМЫСЛ запроса, а не только ключевые слова
    2. Учитывай синонимы и связанные темы
    3. Выбирай меры, которые релевантны запросу пользователя
    4. Если запрос общий (например, "транспорт", "жилье"), выбирай ВСЕ подходящие меры
    5. Если запрос конкретный (например, "компенсация проезда"), выбирай наиболее точные соответствия

    ## ФОРМАТ ОТВЕТА:
    - Если нашлась 1 подходящая мера: верни только её ID (число)
    - Если нашлось несколько мер: каждый ID с новой строки
    - Если ничего не подошло: "unknown measure"

    ## ПРИМЕРЫ:
    Запрос: "ипотека для военных" → 12345
    Запрос: "льготы на транспорт" → 11111⏎22222⏎33333
    Запрос: "абсолютно неподходящий запрос" → unknown measure

    ## ВАЖНО:
    - Возвращай ТОЛЬКО ID в указанном формате
    - Не добавляй пояснения, текст, точки или другие символы
    - Разделяй несколько ID символом новой строки
    - Если сомневаешься - выбирай несколько вариантов

'''

summary_prompt = '''
    Ты - ассистент для создания кратких и понятных саммари мер государственной поддержки.

    # ЗАДАЧА:
    Создай краткое, информативное саммари на основе предоставленной информации о мере поддержки.

    # ТРЕБОВАНИЯ К САММАРИ:
    1. **Краткость** - не более 3-4 предложений
    2. **Информативность** - выдели самую важную информацию
    3. **Структура**:
    - Первое предложение: основная суть меры
    - Второе предложение: ключевые условия/требования
    - Третье предложение: что получает пользователь
    - Четвертое предложение (опционально): важные детали

    4. **Язык**:
    - Простой и понятный язык
    - Без бюрократических формулировок
    - Акцент на пользе для пользователя
    - Используй глаголы действия ("получите", "обратитесь", "предоставьте")

    5. **Формат**:
    - Только чистый текст, без маркеров списков
    - Без заголовков "Саммари:" и т.д.
    - Естественное повествование

    # ПРИМЕРЫ:

    Пример 1:
    Исходные данные: Компенсация проезда в общественном транспорте. Необходимые документы: паспорт, удостоверение ветерана. Срок: 10 дней. Результат: денежная компенсация.
    Саммари: Вы можете получить компенсацию за проезд в общественном транспорте. Для этого потребуется паспорт и удостоверение ветерана. Обработка заявления занимает до 10 рабочих дней. В результате вы получите денежную выплату.

    Пример 2:
    Исходные данные: Льгота на оплату ЖКУ. Документы: справка о доходах, документы на жилье. Срок: 14 дней. Результат: снижение платежей за коммунальные услуги.
    Саммари: Эта мера позволяет снизить расходы на коммунальные услуги. Подготовьте справку о доходах и документы на жилье. Рассмотрение заявления занимает около 2 недель. Вы получите постоянную скидку на оплату ЖКУ.

    # ВАЖНО:
    - Не добавляй информацию, которой нет в исходных данных
    - Сохраняй фактическую точность
    - Делай акцент на практической пользе для пользователя
    - Избегай сложных юридических терминов

    Исходные данные разделены символом | 
    Они состоят из:
    1) Названия 
    2) Срок оказания услуги 
    3) Документы для получения (смотри внимательно, бывает что их нет)
    4) Порядок действий
    5) Результат

    Исходные данные тебе щас пришлют.

'''

class GigaService:
    def __init__(
            self,
            giga_client: GigaClient,
            region_repository: RegionRepository,
            measure_repository: MeasureRepository
    ):
        self._giga_client = giga_client
        self._region_repository = region_repository
        self._measure_repository = measure_repository

    async def recognize_region(self, region: str):
        regions = await self._region_repository.get_all()
        response = await self._giga_client.ask(region_prompt, region)
        for region in regions:
            if response.lower() == region.name.lower():
                return [region]
        return []

    async def recognize_measure(self, okato: str, measure: str):
        measures = await self._measure_repository.get_all(okato)
        measures_names = '\n'.join([f'{measure.measure_id} {measure.name}' for measure in measures])
        prompt = measure_prompt.format(measures_names)
        response = await self._giga_client.ask(prompt, measure)
        recognized_measures = []
        for response_id in response.split('\n'):
            for measure in measures:
                if response_id == str(measure.measure_id):
                    recognized_measures.append(measure)
        return recognized_measures

    async def recognize_summary(self, text: str):
        prompt = summary_prompt
        response = await self._giga_client.ask(prompt, text)
        return response